# 피크월(거래량 기준)

## 목표
   이것의 목표는 손오공과 같이 특정 월에 몰리는 거래량을 가진 종목을 찾아서 매매할떄 참고하기 위함이다.   
   연도별 분기, 연도별 월, 연도별 주 단위로 구분하여 거래량이 몰리는 연도별 단위의 피크점를 찾은 후에 전체연도의 단위의 피크점과 연도별 단위의 피크점의 백분율을 구하여 백분율 순위 출력하기.

---

## 주요 용어
* 단위 구분   
  * 연도별 분기 quarter by year
  * 연도별 월 month by year
  * 연도별 주 weeks by year
* 단위의 피크점 unit peak

---



## 피크월 계산 방법

  1. 장열림 테이블에 거래일이 해당연도의 몇주, 몇 분기에 해당하는지 구한다.
  2. 종목의 같은 연도의 거래일을 (주/월/분기)단위로 묶어 거래량 합을 구한다.
     1. 종목의 해당연도의 일자에 해당하는 주가 몇번째 주인지 구하기
     2. 해당연도의 단위별 거래량 합 구하기
  3. 같은연도의 (주/월/분기)단위별 합의 값으로 같은연도의 단위별 평균값, 평균이하값들, 평균 이상값들, 최저, 최고 값을 구한다.
     1. 평균이하값들, 평균 이상값들에서 연결성의 존재 여부를 찾는다.

  4. 전체년도의 주단위 ***빈도분석*** : 전체연도로 놓고 연도별 최고거래량인 주, 최소거래량인 주, 평균거래량보다 큰 목록의 주, 평균거래량 보다 작은 목록의 주가 몇 퍼센트를 찾는다.
     1. 연도별 종목의 주단위 거래량의 빈도 분석

   추가 ? ) 특정연도의 단위별 최고가를 찾는다고 한다면 최고가 1등과 2등의 차이가 1밖에 없다면 ?? 그래서 배열이 필요함.
      전체연도에서 각자의 연도에서 뽑은 최고와 최저값이 각자의 연도별로 다르겠지? 그래서 각자연도별 최고저값이  전체 연도에서 몇퍼센트를 차지하는지 구하기?
   


---



  

## 실행계획

      빈도가 의미 있는 정보가 되기 위한 필요한 조건은 데이터들이 다 채워져야 한다.
      최소 단위의 데이터가 다 채워 지면 실행시키는게 맞다 .
      최소 단위의 데이터가 채워지기 전에 실행한다면 퍼센트값만 조금더 떨어질뿐.

   - 거래량단위 빈도 분석 티커 생성
   - 데이터 쓰기 티커 종료 후 실행
   - 금일이 단위(주/월)의 마지막인지 체크.
   - 마지막이라면 프로그램 실행.  stock-project-이름



---
      

      meta.code 에서 코드목록 select 해온 후에.
      code별 마지막 저장 단위로 frequency result 테이블의 컬럼을 체크 한 후에. ==> frequency result 의 칼럼 으로 하기.
      칼럼 값보다 큰 데이터를 조회 해야하는데 년 도별 끊어서 조회하기. 
         방법: 
            코드에 해당하는 price의 min과 max 일자를 조회후 연도별 배열을 만들고
            연도 배열을 반복문돌려 연도에 해당하는 데이터를 일자순으로 소트하여 반환 받은 다음.
               
               집계공식 처리하기
                  집계 공식 넣기 전 처리
                     방법:
                        일자별 가격목록 데이터를 요구 단위(주,월,분기)에 맞게 끊어서 단위를 키 일자별 가격목록을 값으로 맵을 만든 후에.
                        반복문을 돌려 가격목록배열에 거래량의 합을 계산 후에 단위별 거래량의 합을  테이블에 저장 할까? 일단 저장 후에 삭제 하자 안쓰니깐
                        저장한다음. 

                  집계공식에 넣어서 처리 
                     방법:
                        코드값과 단위 값에 해당하는 주별 거래량의 합을 조회 해 온 후에 
                        연도별로 평균가, 최고가, 최소가, 최고가범위, 최소가범위를 계산 한 후에 저장한다.


               결과테이블에 저장하기
                  결과테이블 실행 전
                     방법:
                        연도별 집계처리가 완료된 코드값과 단위 값을 받아 전체 연도에 해당하는 집계 테이블을 조회한다.
                        조회한 결과에서 프로그램으로 값과 퍼센트를 구하고
                        저장한다.
            
            모드 결과 테이블저장이 끝나면 단위결 거래량의 합 테이블의 데이터를 지운다.
   
  ---
  



## db

      스키마 
         project-trading-volume
      테이블
         tb_result
         tb_aggregation_by_year
         tb_sum_by_unit
----

   1. 빈도 테이블  tb_result
      | 종목id | 최고거래량인 주 | 최고거래량인 주의 퍼센트 | 최소거래량인 주 | 최소거래량인 주의 퍼센트 | 평균 최소 범위 | 평균 최소 범위의 퍼센트 | 평균 최대 범위 | 평균 최대 범위의 퍼센트 | 마지막 계산일 |
      | ------ | --------------- | ------------------------ | --------------- | ------------------------ | -------------- | ----------------------- | -------------- | ----------------------- | ------------- |

   2. 연도별 집계 테이블 tb_aggregation_by_year
      | 종목id | 단위(주/분기/월) | 연도 | 최고거래량인 단위값(주/분기/월) | 최소거래량인 단위값(주/분기/월) | 평균 이상의 단위값(주/분기/월) 목록 | 평균 이하의 단위값(주/분기/월) 목록 |
      | ------ | ---------------- | ---- | ------------------------------- | ------------------------------- | ----------------------------------- | ----------------------------------- |

   3. 주별 테이블  tb_sum_by_unit
      1. 저장소 낭비
         1. 2000(종목수) * (종목별)전체년도 수 * 52(주) 의 줄 발생
         2. rdb말고 nosql db로 한다면?
         
      2. 연도 파티션 테이블
      
      | 종목id | 연도 | 주  | 거래량의 합 |
      | ------ | ---- | --- | ----------- |

---







## 계산 범위
현재 입력된 달은 매일 갱신.   
매일 테이블을 갱신 시켜줌. 해당년도의 달만.    
하루에 2번 실행 될 되도 문제없게. 
   

---


## 실행시작
가격다 넣고 반등 계산하고.   
종목별 마지막 가격일 조회 해서 가격일 갱신하면 이전 피크월은 계산이 안됨.   

피크월 테이블 기준으로 시작하기 vs 가격 테이블 기준 시작하기   
종목의 마지막 년도 피크월이 있으면? ( 년도포함월 칼럼추가. )    

---